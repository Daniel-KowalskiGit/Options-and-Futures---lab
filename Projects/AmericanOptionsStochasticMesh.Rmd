---
title: "Opcje amerykańskie i drzewa losowe"
output: html_document
date: "`r Sys.Date()`"
---

#TODO: ze screenshot'ów z [1] możemy zostawić tylko rysunki, oczywiście z podpisanym źródłem, pod każdym z nich; wzory matematyczne z pozostałych screenshot'ów należy przepisać w LaTeX'u, a tekst zwięźle przetłumaczyć.

# Wstęp

Projekt jest ćwiczeniem z wyceny opcji metodą Monte Carlo. Przedstawiamy przykłady numeryczne dla algorytmów wyceny opcji amerykańskich, opisanych w [1], w rozdziale 8.5 pt. "Stochastic Mesh Methods".

# Opcje amerykańskie - optymalne stopowanie

Znajdźmy wartość $V_0$ opcji w chwili $t_0=0$. Niech $h_i$ oznacza zdyskontowaną wypłatę z opcji w chwili $t_i$, zwaną też wewnętrzną wartością (*intrinsic value*) opcji. Ponieważ opcję amerykańską możemy w każdej chwili zrealizować (otrzymując $h_i$) lub czekać, jej wartość jest nie mniejsza od wartości wewnętrznej.

Zdyskontowana wartość $V_i(X_i)$ opcji w chwili $t_i$ na rynku znajdującym się w stanie $X_i$ (w ogólności, $X_i$ jest wektorem zawierającym ceny instrumentów, losowe stopy procentowe $r$, poziom zmienności rynku $\sigma$, itd.), jest dana równaniem rekurencyjnym (patrz [1], równania (8.6)-(8.7)):

$$
V_m(x) = h_m(x),\\
V_{i}(x) = \max\{ h_{i}(x), \; C_{i}(x) \},\quad 0\le i\le m-1,\\
\text{gdzie}\quad 
C_{i}(x) = E[V_{i+1}(X_{i+1}) \;|\; X_{i}=x].
$$

Powyższe wzory definiują obwiednię Snella $V_i(X_i)$ ciągu $h_i(X_i)$, czyli najmniejszy nadmartyngał dominujący funkcję wypłaty. Z teorii optymalnego stopowania (p. [2], dodatek F.2, Twierdzenie 3) wiadomo, że

$$
V_0(X_0) = Eh_{\tau^*}(X_{\tau^*}) = \sup_{\tau\in\Theta} Eh_{\tau}(X_{\tau}),
$$

gdzie $\Theta$ jest zbiorem wszystkich momentów stopu o wartościach w zbiorze $\{0,1,\ldots,m\}$.

# Programowanie dynamiczne

Implementacje rozwiązań układu równań (1) zazwyczaj odnoszą się do jego równoważnej postaci, gdzie funkcje $\tilde h_i$ oraz $\tilde V_i$ nie są zdyskontowane (patrz [1], równania (8.4)-(8.5)):

$$
\tag{2}
\tilde V_m(x) = \tilde h_m(x),\\
\tilde V_{i}(x) = \max\{ \tilde h_{i}(x), \; E[D_{i,i+1}(X_{i+1})\tilde V_{i+1}(X_{i+1}) \;|\; X_{i}=x] \},\quad 0\le i\le m-1.
$$

Szukamy wtedy $\tilde V_0(X_0)=V_0(X_0)$. Czynnik $D_{i,i+1}$ jest współczynnikiem dyskonta pomiędzy momentem $t_{i+1}$ a $t_{i}$ , czyli wartością, w momencie $t_{i}$, jednego dolara wypłacanego w przyszłej chwili $t_{i+1}$. Dla prostego modelu ze stałą stopą procentową $r$, jest to po prostu $\exp(-r(t_{i+1}-t_{i}))$.

Równoważność sfomułowań (1) i (2) można zobaczyć, jeśli zauważymy, że

$$
V_i = \exp(-rt_i)\tilde V_i,
\qquad 
h_i = \exp(-rt_i)\tilde h_i.
$$

Zaletą sformułowania (2) jest to, że funkcja wypłaty $\tilde h_i$ jest zazwyczaj niezależna od indeksu $i$.

Wyznaczymy dwa estymatory, "górny" $\hat V$ i "dolny" $\hat v$:

$$
E\hat V_0 \ge V_0(X_0) \ge E\hat v_0.
$$

# Estymator górny

Oznaczmy przez $X_{ij}$ węzeł naszej siatki, a dokładnie $j$-ty węzeł związany z $i$-tym momentem, $t_i$, w którym można zrealizować opcję, gdzie $i=1, \ldots,m$, zaś $j=1,\ldots,b$. Zakładamy oczywiście, że

$$
t_0<t_1<\ldots<t_m,
$$

gdzie $t_0$ jest chwilą obecną, dla której mamy dodatkowy, pojedynczy węzeł siatki, $X_0$.

Będziemy używać symbolu $\hat V_{ij}$ dla przybliżonej wartości opcji w tym węźle, wyliczonej następująco metodą rekursji wstecznej. W węzłach końcowych ($i=m$), definiujemy $\hat V_{mj} = \tilde h_{m}(X_{mj})$. Następnie, definiujemy

$$
\hat V_{ij} = \max\left\{
\tilde h_i(X_{ij}),
\frac1b \sum_{k=1}^b 
  W^i_{jk} D_{i,i+1}(X_{i+1,k}) \hat V_{i+1,k},
\right\}
$$

dla pewnych wartości wagowych $W^i_{jk}$.

Na koniec, w węźle $X_0$ definiujemy

$$
\hat V_0 = 
\frac1b \sum_{k=1}^b 
  D_{0,1}(X_{1,k}) \hat V_{1,k},
$$

bądź też maksimum z tego i z $h_0(X_0)$, gdy dopuszczamy możliwość realizacji opcji w chwili $t_0$.

Głównym zagadnieniem w tej metodzie jest odpowiedni wybór współczynników wagowych $W^i_{jk}$. Jest to ściśle związane z metodą otrzymywania kolejnych węzłów $X_{ij}$. Można np. losować niezależne trajektorie procesu Markowa $X_i$, ale nie jest to jedyny sposób generowania siatki.

# Założenia o siatce losowej

Podamy teraz warunki dla siatki, których spełnianie wystarcza do konstrukcji estymatora ,,górnego'', tj. obciążonego dodatnio, i estymatora ,,dolnego'', tj. obciążonego ujemnie.

Niech wektor losowy

$$
X_i = (X_{i1},\ldots,X_{ib})
$$

będzie ,,stanem siatki'' w $i$-tym kroku czasowym, składającym się ze wszystkich węzłów przypisanych do tego samego momentu czasu, dla $i=1,\ldots,m$, i niech $X_0$ będzie ustalone. Zakładamy, że konstrukcja siatki spełnia warunek Markowa w następującym sensie:

**(M1)** Dla każdego $i=1,\ldots,m-1$, i dla każdej funkcji mierzalnej $f$, zachodzi:

$$
E\Big[\, 
 Y
\:|\:
X_0,\ldots,X_{i-1},X_i
\,\Big]
=
E\Big[\, 
 Y
\:|\:
X_i
\,\Big],
\quad\text{gdy}\;
Y=f(X_{i+1},\ldots,X_{m}).
$$

Biorąc, po obu stronach powyższej równości, warunkową wartość oczekiwaną względem $\{X_{i-1},X_i\}$, otrzymujemy w szczególności $E[Y|X_{i-1},X_i]=E[Y|X_i]$, co zachodzi również dla $Y=f(X_i,X_{i+1},\ldots,X_{m})$, przy każdej mierzalnej funkcji $f$ (p. [3], wniosek 8.11 (i), str. 171).

Zakładamy też, że spełnione jest założenie:

**(M2)** Każda z wag $W^i_{jk}$ jest funkcją mierzalną $X_i$ i $X_{i+1}$.

W szczególności, $W^i_{jk}$ może być mierzalną funkcją wartości $X_{ij}$ oraz $X_{i+1,k}$.

Przypomnijmy, że $C_i(x)$ oznacza wartość oczekiwaną wypłaty z realizacji opcji w chwili późniejszej, tzw. wartość kontynuacji inwestycji. Następny warunek nakłada ograniczenia na wybór wag, tak by pozwalały poprawnie szacować tę wartość, przeciętnie:

**(M3)** Dla każdego $i=1,\ldots,m-1$ i dla każdego $j=1,\ldots,b$,

$$
\frac1b \sum_{k=1}^b
E\Big[
W^i_{jk} D_{i,i+1}(X_{i+1,k}) V_{i+1}(X_{i+1,k})
\:|\:
X_i
\Big]
=
C_i(X_{ij}).
$$

# Estymator dolny - stopowanie suboptymalne

![](images/Screenshot%202022-12-07%20at%2015.57.20.png)

![](images/Screenshot%202022-12-07%20at%2015.57.44.png)

![](images/Screenshot%202022-12-07%20at%2015.58.00.png)

# Konstrukcja siatki i iloraz wiarygodności

![](images/Screenshot%202022-12-07%20at%2015.58.27.png)

![](images/Screenshot%202022-12-07%20at%2015.59.10.png)

![](images/Screenshot%202022-12-07%20at%2015.59.20.png)

![](images/Screenshot%202022-12-07%20at%2015.59.42.png)

![](images/Screenshot%202022-12-07%20at%2016.00.02.png)

# Wagi estymatora dolnego

![](images/Screenshot%202022-12-07%20at%2016.00.30.png)

# Przykład numeryczny - opcje amerykańskie dla średniej geometrycznej z siedmiu aktywów

![](images/Screenshot%202022-12-07%20at%2016.13.54.png)

W niniejszym przykładzie zakładamy, że ceny siedmiu aktywów, $X=(S^1,S^2,\ldots,S^7)$ ewoluują niezależnie, zgodnie z równaniem:

$$
dS^k = (r-
\delta)dt + \sigma dW^k,
\qquad k=1,2,\ldots,7,
$$

gdzie procesy Wienera $W^1,\ldots,W^7$ są niezależne; co modelujemy wg schematu Eulera:

$$
S^k_{i+1} = S^k_i \exp((r-\delta-\tfrac12\sigma^2)dt 
+\sigma\sqrt{dt}Z^k), \\
\qquad k=1,\ldots,7,
\quad Z^k \sim N(0,1).
$$

![](images/Screenshot%202022-12-07%20at%2016.01.11.png)

![](images/Screenshot%202022-12-07%20at%2016.01.23.png)

![](images/Screenshot%202022-12-07%20at%2016.14.04.png)

# Literatura:

[1] Paul Glasserman, *Monte Carlo Methods in Financial Engineering*, Springer, 2003

[2] J. Jakubowski, R. Sztencel, *Wstęp do teorii prawdopodobieństwa*, Wyd. 4. SCRIPT, Warszawa, 2010

[3] O. Kallenberg, *Foundations of Modern Probability*, Springer, 2021
